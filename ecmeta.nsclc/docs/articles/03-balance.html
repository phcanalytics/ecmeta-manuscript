<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Propensity score weighting and assessment of covariate balance • ecmeta.nsclc</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/cerulean/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Propensity score weighting and assessment of covariate balance">
<meta property="og:description" content="ecmeta.nsclc">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">ecmeta.nsclc</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.1.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">API</a>
</li>
<li>
  <a href="../sap/sap.pdf">Analysis plan</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Analysis
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/01-data-prep.html">Data preparation</a>
    </li>
    <li>
      <a href="../articles/02-impute.html">Imputation of missing data</a>
    </li>
    <li>
      <a href="../articles/03-balance.html">Propensity score estimation, weighting, and balance</a>
    </li>
    <li>
      <a href="https://connect.phcaa.science.roche.com/content/1102">Propensity score estimation, weighting, and balance (Shiny app)</a>
    </li>
    <li>
      <a href="../articles/04-ate-trt-ec.html">Treatment effect estimates: RCT experimental vs external control</a>
    </li>
    <li>
      <a href="../articles/05-ic-ec.html">Comparison of the internal and external control arms</a>
    </li>
    <li>
      <a href="../articles/06-ecmeta.html">Meta-analytic adjustment of hazard ratios</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/phcanalytics/ecmeta-manuscript/tree/master/ecmeta.nsclc/">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="03-balance_files/kePrint-0.0.1/kePrint.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Propensity score weighting and assessment of covariate balance</h1>
            
            <h4 class="date">2021-10-01</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/phcanalytics/ecmeta-manuscript/tree/master/ecmeta.nsclc/vignettes/03-balance.Rmd"><code>vignettes/03-balance.Rmd</code></a></small>
      <div class="hidden name"><code>03-balance.Rmd</code></div>

    </div>

    
    
<div id="setup" class="section level1">
<h1 class="hasAnchor">
<a href="#setup" class="anchor"></a>Setup</h1>
<p>The objectives of this analysis are to estimate the propensity score, weight the external control population so that its covariate distribution matches the clinical trial, and assess balance after weighting. Both inverse probability of treatment weighting with weights constructed for estimation of the average treatment effect for the treated (i.e., IPTW-ATT weights) and matching techniques are employed. The following <code>R</code> packages are used.</p>
<div class="sourceCode" id="cb1"><html><body><pre class="r"><span class="co"># R packages</span>
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="st">"dplyr"</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="st">"ecmeta.nsclc"</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="st">"ggplot2"</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="st">"kableExtra"</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="st">"purrr"</span>)

<span class="co"># Settings</span>
<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme_get.html">theme_set</a></span>(<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span>())</pre></body></html></div>
</div>
<div id="propensity-score-estimation" class="section level1">
<h1 class="hasAnchor">
<a href="#propensity-score-estimation" class="anchor"></a>Propensity score estimation</h1>
<p>Logistic regression is used to estimate the propensity score. The variables in the columns of the table below are considered for inclusion in the model. A 1 in the table indicates that a given variable was used for a particular analysis and a 0 indicates that it was not.</p>
<div class="sourceCode" id="cb2"><html><body><pre class="r"><span class="kw pkg">ecmeta.nsclc</span><span class="kw ns">::</span><span class="no"><a href="../reference/psmodel_specification.html">psmodel_specification</a></span> <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span>(-<span class="no">interaction</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="../reference/html_table.html">html_table</a></span>() <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/kableExtra/man/scroll_box.html">scroll_box</a></span>(<span class="kw">width</span> <span class="kw">=</span> <span class="st">"100%"</span>)</pre></body></html></div>
<div style="border: 1px solid #ddd; padding: 5px; overflow-x: scroll; width:100%; ">
<table class="table table table-striped table-responsive">
<thead><tr>
<th style="text-align:right;">
analysis_num
</th>
<th style="text-align:left;">
analysis_id
</th>
<th style="text-align:right;">
sex
</th>
<th style="text-align:right;">
race_grouped
</th>
<th style="text-align:right;">
age
</th>
<th style="text-align:right;">
smoker_grouped
</th>
<th style="text-align:right;">
histology
</th>
<th style="text-align:right;">
stage_grouped
</th>
<th style="text-align:right;">
days_since_dx
</th>
</tr></thead>
<tbody>
<tr>
<td style="text-align:right;">
1
</td>
<td style="text-align:left;">
nct02008227_fi_1
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
1
</td>
</tr>
<tr>
<td style="text-align:right;">
2
</td>
<td style="text-align:left;">
nct01903993_fi_1
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
1
</td>
</tr>
<tr>
<td style="text-align:right;">
3
</td>
<td style="text-align:left;">
nct02366143_fi_1
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
1
</td>
</tr>
<tr>
<td style="text-align:right;">
4
</td>
<td style="text-align:left;">
nct01351415_fi_1
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
1
</td>
</tr>
<tr>
<td style="text-align:right;">
5
</td>
<td style="text-align:left;">
nct01519804_fi_1
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
1
</td>
</tr>
<tr>
<td style="text-align:right;">
6
</td>
<td style="text-align:left;">
nct01496742_fi_1
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
1
</td>
</tr>
<tr>
<td style="text-align:right;">
7
</td>
<td style="text-align:left;">
nct01496742_fi_2
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
1
</td>
</tr>
<tr>
<td style="text-align:right;">
8
</td>
<td style="text-align:left;">
nct01366131_fi_1
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
1
</td>
</tr>
<tr>
<td style="text-align:right;">
9
</td>
<td style="text-align:left;">
nct01493843_fi_1
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
</tr>
<tr>
<td style="text-align:right;">
10
</td>
<td style="text-align:left;">
nct01493843_fi_2
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
</tr>
<tr>
<td style="text-align:right;">
11
</td>
<td style="text-align:left;">
nct01493843_fi_3
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
</tr>
<tr>
<td style="text-align:right;">
12
</td>
<td style="text-align:left;">
nct02367781_fi_1
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
1
</td>
</tr>
<tr>
<td style="text-align:right;">
13
</td>
<td style="text-align:left;">
nct02367794_fi_1
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
1
</td>
</tr>
<tr>
<td style="text-align:right;">
14
</td>
<td style="text-align:left;">
nct02657434_fi_1
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
1
</td>
</tr>
</tbody>
</table>
</div>
<p>We then create formulas using these variables for the propensity score models. We considered natural cubic splines (<code><a href="https://rdrr.io/r/splines/ns.html">splines::ns()</a></code>) for the continuous variables and an interaction between cancer stage and time since initial diagnosis. Both resulted in more extreme weights and did not improve balance, so they are not included here.</p>
<div class="sourceCode" id="cb3"><html><body><pre class="r"><span class="no">analysis</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">readRDS</a></span>(<span class="st">"analysis-impute.rds"</span>)
<span class="no">analysis</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/ps_formula.html">add_ps_formula</a></span>(<span class="no">analysis</span>, <span class="kw">spline</span> <span class="kw">=</span> <span class="fl">FALSE</span>, <span class="kw">interaction</span> <span class="kw">=</span> <span class="fl">FALSE</span>)</pre></body></html></div>
<p>Separate logistic regressions are fit for each of the 14 analyses and each of the 5 multiply imputed datasets.</p>
<div class="sourceCode" id="cb4"><html><body><pre class="r"><span class="no">analysis</span>$<span class="no">ps_model</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map2.html">map2</a></span>(<span class="no">analysis</span>$<span class="no">ps_formula</span>, <span class="no">analysis</span>$<span class="no">impute_xdata</span>, <span class="kw">function</span> (<span class="no">x</span>, <span class="no">y</span>) {
  <span class="fu"><a href="../reference/fit_ps.html">fit_ps_mi</a></span>(<span class="kw">formula</span> <span class="kw">=</span> <span class="no">x</span>, <span class="kw">data</span> <span class="kw">=</span> <span class="no">y</span>)
})</pre></body></html></div>
<p>The logistic regression models are used to predict estimate the propensity scores.</p>
<div class="sourceCode" id="cb5"><html><body><pre class="r"><span class="no">analysis</span>$<span class="no">ps</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span>(<span class="no">analysis</span>$<span class="no">ps_model</span>, <span class="no">predict_ps</span>)</pre></body></html></div>
</div>
<div id="propensity-score-weighting" class="section level1">
<h1 class="hasAnchor">
<a href="#propensity-score-weighting" class="anchor"></a>Propensity score weighting</h1>
<p>The propensity score models are used to predict propensity scores and generate weights for each patient. Both IPTW and 1:1 nearest neighbor matching are used to generate the weights. In cases where the number of external control patients was less than the number of trial patients, matching is performed with replacement; otherwise, matching is performed without replacement. Matching was conducted with and without a caliper (of 0.25 standard deviations of the linear propensity score) and IPTW was conducted with and without trimming (i.e., excluding <em>external control patients</em> with values of the propensity less than the 1st percentile or above the 99th percentile).</p>
<div class="sourceCode" id="cb6"><html><body><pre class="r"><span class="no">ps_methods</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(
  <span class="st">"iptw_att"</span>, <span class="st">"iptw_att_trim"</span>,
  <span class="st">"match_nearest"</span>, <span class="st">"match_nearest_caliper"</span>,
  <span class="st">"match_genetic"</span>, <span class="st">"match_genetic_caliper"</span>
)
<span class="no">analysis</span>$<span class="no">psweight</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/psweight.html">psweight</a></span>(<span class="no">analysis</span>$<span class="no">ps</span>, <span class="kw">methods</span> <span class="kw">=</span> <span class="no">ps_methods</span>,
                              <span class="kw">progress</span> <span class="kw">=</span> <span class="fl">TRUE</span>,
                              <span class="kw">print.level</span> <span class="kw">=</span> <span class="fl">0</span>, <span class="kw">outfile</span> <span class="kw">=</span> <span class="st">"psweight_out"</span>,
                              <span class="kw">pop.size</span> <span class="kw">=</span> <span class="fl">1000</span>)</pre></body></html></div>
<pre><code>## Loading required namespace: rgenoud</code></pre>
<div class="sourceCode" id="cb8"><html><body><pre class="r"><span class="no">psw</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/rbind_list.html">rbind_list</a></span>(<span class="no">analysis</span>$<span class="no">psweight</span>, <span class="kw">id</span> <span class="kw">=</span> <span class="st">"analysis_num"</span>,
                  <span class="kw">integer_id</span> <span class="kw">=</span> <span class="fl">TRUE</span>)</pre></body></html></div>
<p>We focus our assessments on the IPTW-ATT weighted models, which we consider our primary analysis. A comparison of all propensity score methods is available in the <a href="#sensitivity">sensitivity analyses</a> below.</p>
<div id="distribution-of-weights" class="section level2">
<h2 class="hasAnchor">
<a href="#distribution-of-weights" class="anchor"></a>Distribution of weights</h2>
<p>The distribution of weights for the external control patients are plotted to check for the potential influence of extreme propensity scores. Plots are provided for weights generated with and without trimming. No weights are provided for the trial patients since they are all given a weight of 1.</p>
<div class="sourceCode" id="cb9"><html><body><pre class="r"><span class="fu"><a href="../reference/plot_weights.html">plot_weights</a></span>(<span class="no">psw</span>, <span class="kw">method</span> <span class="kw">=</span> <span class="st">"iptw_att"</span>)</pre></body></html></div>
<p><img src="03-balance_files/figure-html/plotWeight-1.png" width="700"></p>
<div class="sourceCode" id="cb10"><html><body><pre class="r"><span class="fu"><a href="../reference/plot_weights.html">plot_weights</a></span>(<span class="no">psw</span>, <span class="kw">method</span> <span class="kw">=</span> <span class="st">"iptw_att_trim"</span>)</pre></body></html></div>
<p><img src="03-balance_files/figure-html/plotWeightTrim-1.png" width="700"></p>
</div>
</div>
<div id="assessment-of-balance" class="section level1">
<h1 class="hasAnchor">
<a href="#assessment-of-balance" class="anchor"></a>Assessment of balance</h1>
<div id="distribution-of-the-propensity-score" class="section level2">
<h2 class="hasAnchor">
<a href="#distribution-of-the-propensity-score" class="anchor"></a>Distribution of the propensity score</h2>
<p>Density plots of the propensity score in each analysis for the treated (trial) and external control patients are shown below. We begin by plotting the unadjusted propensity score (i.e., without weighting).</p>
<div class="sourceCode" id="cb11"><html><body><pre class="r"><span class="fu"><a href="../reference/plot_ps.html">plot_ps</a></span>(<span class="no">psw</span>, <span class="kw">method</span> <span class="kw">=</span> <span class="st">"unadjusted"</span>)</pre></body></html></div>
<p><img src="03-balance_files/figure-html/plosPSUnadjusted-1.png" width="960"></p>
<p>We then plot weighted propensity score with and without trimming.</p>
<div class="sourceCode" id="cb12"><html><body><pre class="r"><span class="fu"><a href="../reference/plot_ps.html">plot_ps</a></span>(<span class="no">psw</span>, <span class="kw">method</span> <span class="kw">=</span> <span class="st">"iptw_att"</span>)</pre></body></html></div>
<p><img src="03-balance_files/figure-html/plosPSIptwAtt-1.png" width="960"></p>
<div class="sourceCode" id="cb13"><html><body><pre class="r"><span class="fu"><a href="../reference/plot_ps.html">plot_ps</a></span>(<span class="no">psw</span>, <span class="kw">method</span> <span class="kw">=</span> <span class="st">"iptw_att_trim"</span>)</pre></body></html></div>
<p><img src="03-balance_files/figure-html/plosPSIptwAttTrim-1.png" width="960"></p>
</div>
<div id="standardized-mean-differences" class="section level2">
<h2 class="hasAnchor">
<a href="#standardized-mean-differences" class="anchor"></a>Standardized mean differences</h2>
<p>We define the standardized mean difference (SMD) as <span class="math inline">\((\mu_t - \mu_c)\sigma\)</span> where <span class="math inline">\(\mu_t\)</span> is the weighted mean among the treated patients, <span class="math inline">\(\mu_c\)</span> is the weighted mean among the control patients, and <span class="math inline">\(\sigma\)</span> is the standard deviation among the treated patients in the unweighted sample.</p>
<div class="sourceCode" id="cb14"><html><body><pre class="r"><span class="no">smd_out</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/smd.html">smd</a></span>(<span class="no">psw</span>)</pre></body></html></div>
<p>SMDs are plotted for the estimated propensity score as well as each term in the propensity score model. We consider IPTW-ATT weights with and without trimming. Line ranges represent the minimum and maximum values from the multiple imputations and the point is the median value.</p>
<div class="sourceCode" id="cb15"><html><body><pre class="r"><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html">autoplot</a></span>(<span class="no">smd_out</span>, <span class="kw">method</span> <span class="kw">=</span> <span class="st">"iptw_att"</span>)</pre></body></html></div>
<p><img src="03-balance_files/figure-html/smdPlotIptwAtt-1.png" width="960"></p>
<div class="sourceCode" id="cb16"><html><body><pre class="r"><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html">autoplot</a></span>(<span class="no">smd_out</span>, <span class="kw">method</span> <span class="kw">=</span> <span class="st">"iptw_att_trim"</span>)</pre></body></html></div>
<p><img src="03-balance_files/figure-html/smdPlotIptwAttTrim-1.png" width="960"></p>
<p>For comparison, we also plot SMDs where <span class="math inline">\(\mu_t\)</span> and <span class="math inline">\(\mu_c\)</span> are not weighted.</p>
<div class="sourceCode" id="cb17"><html><body><pre class="r"><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html">autoplot</a></span>(<span class="no">smd_out</span>, <span class="kw">method</span> <span class="kw">=</span> <span class="st">"unadjusted"</span>)</pre></body></html></div>
<p><img src="03-balance_files/figure-html/smdPlotUnadj-1.png" width="960"></p>
</div>
<div id="distribution-of-continuous-covariates" class="section level2">
<h2 class="hasAnchor">
<a href="#distribution-of-continuous-covariates" class="anchor"></a>Distribution of continuous covariates</h2>
<p>We also plot the distributions of the continuous covariates to assess balance on high order moments. We compare the trimmed IPTW-ATT weighted distributions to the unadjusted distributions. Recall that time since diagnosis was not included as a covariate in analysis 5.</p>
<div class="sourceCode" id="cb18"><html><body><pre class="r"><span class="fu"><a href="../reference/plot_density.html">plot_density</a></span>(<span class="no">psw</span>, <span class="kw">method</span> <span class="kw">=</span> <span class="st">"iptw_att_trim"</span>, <span class="kw">var</span> <span class="kw">=</span> <span class="st">"age"</span>, <span class="kw">xlab</span> <span class="kw">=</span> <span class="st">"Age"</span>)</pre></body></html></div>
<p><img src="03-balance_files/figure-html/densityPlotAge-1.png" width="700"></p>
<div class="sourceCode" id="cb19"><html><body><pre class="r"><span class="fu"><a href="../reference/plot_density.html">plot_density</a></span>(<span class="no">psw</span>, <span class="kw">method</span> <span class="kw">=</span> <span class="st">"unadjusted"</span>, <span class="kw">var</span> <span class="kw">=</span> <span class="st">"age"</span>, <span class="kw">xlab</span> <span class="kw">=</span> <span class="st">"Age"</span>)</pre></body></html></div>
<p><img src="03-balance_files/figure-html/densityPlotAgeUnadjusted-1.png" width="700"></p>
<div class="sourceCode" id="cb20"><html><body><pre class="r"><span class="fu"><a href="../reference/plot_density.html">plot_density</a></span>(<span class="no">psw</span>, <span class="kw">method</span> <span class="kw">=</span> <span class="st">"iptw_att_trim"</span>, <span class="kw">var</span> <span class="kw">=</span> <span class="st">"days_since_dx"</span>,
             <span class="kw">xlab</span> <span class="kw">=</span> <span class="st">"Days since diagnosis"</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_cartesian.html">coord_cartesian</a></span>(<span class="kw">xlim</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">0</span>, <span class="fl">1000</span>))</pre></body></html></div>
<p><img src="03-balance_files/figure-html/densityPlotDaysSinceDx-1.png" width="700"></p>
<div class="sourceCode" id="cb21"><html><body><pre class="r"><span class="fu"><a href="../reference/plot_density.html">plot_density</a></span>(<span class="no">psw</span>, <span class="kw">method</span> <span class="kw">=</span> <span class="st">"unadjusted"</span>, <span class="kw">var</span> <span class="kw">=</span> <span class="st">"days_since_dx"</span>,
             <span class="kw">xlab</span> <span class="kw">=</span> <span class="st">"Days since diagnosis"</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_cartesian.html">coord_cartesian</a></span>(<span class="kw">xlim</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">0</span>, <span class="fl">1000</span>))</pre></body></html></div>
<p><img src="03-balance_files/figure-html/densityPlotDaysSinceDxUnadjusted-1.png" width="700"></p>
</div>
</div>
<div id="sensitivity" class="section level1">
<h1 class="hasAnchor">
<a href="#sensitivity" class="anchor"></a>Sensitivity analyses</h1>
<p>Two sensitivity analyses are performed. First, we compare the different propensity score methods. Comparisons are made by evaluating SMDs for the logit of the propensity scores. Second, we consider a very simple propensity score model that only includes one covariate – age. We then compared SMDs between the fully specified propensity score model and the age only model when using IPTW-ATT weights with trimming.</p>
<div id="propensity-score-method" class="section level2">
<h2 class="hasAnchor">
<a href="#propensity-score-method" class="anchor"></a>Propensity score method</h2>
<div class="sourceCode" id="cb22"><html><body><pre class="r"><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html">autoplot</a></span>(<span class="no">smd_out</span>, <span class="kw">method</span> <span class="kw">=</span> <span class="kw">NULL</span>)</pre></body></html></div>
<p><img src="03-balance_files/figure-html/smdPlotSensitivity-1.png" width="960"></p>
</div>
<div id="variable-selection" class="section level2">
<h2 class="hasAnchor">
<a href="#variable-selection" class="anchor"></a>Variable selection</h2>
<div class="sourceCode" id="cb23"><html><body><pre class="r"><span class="no">f_age</span> <span class="kw">&lt;-</span> <span class="no">treat</span> ~ <span class="no">age</span>
<span class="no">analysis</span>$<span class="no">ps_model_age</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span>(<span class="no">analysis</span>$<span class="no">impute_xdata</span>, <span class="kw">function</span> (<span class="no">x</span>) {
  <span class="fu"><a href="../reference/fit_ps.html">fit_ps_mi</a></span>(<span class="kw">formula</span> <span class="kw">=</span> <span class="no">f_age</span>, <span class="kw">data</span> <span class="kw">=</span> <span class="no">x</span>)
})
<span class="no">analysis</span>$<span class="no">ps_age</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span>(<span class="no">analysis</span>$<span class="no">ps_model_age</span>, <span class="no">predict_ps</span>)
<span class="no">psw_age</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/psweight.html">psweight</a></span>(<span class="no">analysis</span>$<span class="no">ps_age</span>, <span class="kw">methods</span> <span class="kw">=</span> <span class="st">"iptw_att_trim"</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="../reference/rbind_list.html">rbind_list</a></span>(<span class="kw">id</span> <span class="kw">=</span> <span class="st">"analysis_num"</span>, <span class="kw">integer_id</span> <span class="kw">=</span> <span class="fl">TRUE</span>)
<span class="no">smd_age</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/smd.html">smd</a></span>(<span class="no">psw_age</span>, <span class="kw">x_vars</span> <span class="kw">=</span> <span class="fu">get_ps_vars</span>())
<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html">autoplot</a></span>(<span class="fu"><a href="../reference/smd_list.html">smd_list</a></span>(<span class="kw">`Full model`</span> <span class="kw">=</span> <span class="no">smd_out</span>, <span class="kw">`Age only model`</span> <span class="kw">=</span> <span class="no">smd_age</span>),
        <span class="kw">method</span> <span class="kw">=</span> <span class="st">"iptw_att_trim"</span>)</pre></body></html></div>
<p><img src="03-balance_files/figure-html/psfitsAge-1.png" width="960"></p>
</div>
</div>
<div id="save-output" class="section level1">
<h1 class="hasAnchor">
<a href="#save-output" class="anchor"></a>Save output</h1>
<div class="sourceCode" id="cb24"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">saveRDS</a></span>(<span class="no">analysis</span>, <span class="kw">file</span> <span class="kw">=</span> <span class="st">"analysis-balance.rds"</span>)</pre></body></html></div>
</div>
<div id="session-information" class="section level1">
<h1 class="hasAnchor">
<a href="#session-information" class="anchor"></a>Session information</h1>
<div class="sourceCode" id="cb25"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/utils/sessionInfo.html">sessionInfo</a></span>()</pre></body></html></div>
<pre><code>## R version 4.0.0 (2020-04-24)
## Platform: x86_64-pc-linux-gnu (64-bit)
## Running under: Ubuntu 18.04.5 LTS
## 
## Matrix products: default
## BLAS:   /usr/lib/x86_64-linux-gnu/openblas/libblas.so.3
## LAPACK: /usr/lib/x86_64-linux-gnu/libopenblasp-r0.2.20.so
## 
## locale:
##  [1] LC_CTYPE=en_US.UTF-8       LC_NUMERIC=C              
##  [3] LC_TIME=en_US.UTF-8        LC_COLLATE=en_US.UTF-8    
##  [5] LC_MONETARY=en_US.UTF-8    LC_MESSAGES=en_US.UTF-8   
##  [7] LC_PAPER=en_US.UTF-8       LC_NAME=C                 
##  [9] LC_ADDRESS=C               LC_TELEPHONE=C            
## [11] LC_MEASUREMENT=en_US.UTF-8 LC_IDENTIFICATION=C       
## 
## attached base packages:
## [1] stats     graphics  grDevices utils     datasets  methods   base     
## 
## other attached packages:
## [1] purrr_0.3.4        kableExtra_1.1.0   ggplot2_3.3.0      ecmeta.nsclc_0.1.0
## [5] dplyr_1.0.7       
## 
## loaded via a namespace (and not attached):
##  [1] Matching_4.9-7    tidyselect_1.1.1  xfun_0.13         splines_4.0.0    
##  [5] lattice_0.20-41   colorspace_1.4-1  vctrs_0.3.8       generics_0.1.0   
##  [9] htmltools_0.4.0   viridisLite_0.3.0 yaml_2.2.1        utf8_1.2.1       
## [13] survival_3.1-12   rlang_0.4.11      pkgdown_1.5.1     pillar_1.6.1     
## [17] glue_1.4.2        withr_2.4.2       DBI_1.1.1         lifecycle_1.0.0  
## [21] stringr_1.4.0     munsell_0.5.0     gtable_0.3.0      rvest_0.3.5      
## [25] codetools_0.2-16  memoise_1.1.0     evaluate_0.14     labeling_0.3     
## [29] knitr_1.28        fansi_0.5.0       highr_0.8         Rcpp_1.0.6       
## [33] readr_1.4.0       scales_1.1.0      backports_1.2.1   desc_1.2.0       
## [37] webshot_0.5.2     rgenoud_5.8-3.0   farver_2.0.3      fs_1.5.0         
## [41] hms_1.1.0         digest_0.6.27     stringi_1.6.2     grid_4.0.0       
## [45] rprojroot_1.3-2   tools_4.0.0       magrittr_2.0.1    tibble_3.1.2     
## [49] crayon_1.4.1      pkgconfig_2.0.3   MASS_7.3-51.6     ellipsis_0.3.2   
## [53] Matrix_1.3-2      data.table_1.13.2 xml2_1.3.2        assertthat_0.2.1 
## [57] rmarkdown_2.1     httr_1.4.2        rstudioapi_0.13   R6_2.5.0         
## [61] compiler_4.0.0</code></pre>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Devin Incerti, Michael Bretscher, Ray Lin, Chris Harbron.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.5.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
